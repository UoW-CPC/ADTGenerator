tosca_definitions_version: tosca_simple_yaml_1_2

metadata:
  id: "{{ id }}"
  name: "{{ name }}"
  author: "{{ author }}"
  date: "{{ date }}"
  version: "{{ version }}"
  classificationSchema: "{{ classificationSchema }}"
  type:
  {%- for _type in type %}
  - "{{ _type }}"
  {%- endfor %}

description: "{{ description }}"

imports:
- https://raw.githubusercontent.com/micado-scale/tosca/develop/micado_types.yaml

{%- for microservice in deploymentMapping %}
- {{ microservice }}.yaml
{%- endfor %}
{%- for host in deploymentMapping.values() | unique %}
- {{ host }}.yaml
{%- endfor %}

topology_template:
  node_templates:
  {%- for microservice in listOfMicroservices %}
    {{microservice}}:
      type: micado.{{ microservice }}
      requirements:
      {%- for _microservice in deploymentMapping.items() %}
      {%- set _microservice, host = _microservice %}
      {%- if _microservice == microservice %}
      - host: {{host}}
      {%- endif %}
      {%- endfor %}
      {%- if volumeMapping != NULL %}
      {%- for _microservice in volumeMapping.items() %}
      {%- set _microservice, volumelist = _microservice %}
      {%- if _microservice == microservice %}
      {%- for volume in volumelist %}
      - volume: {{volume}}
      {%- endfor %}
      {%- endif %}
      {%- endfor %}
      {%- endif %}
  {%- endfor %}

  {%- for host in deploymentMapping.values() | unique %}
    {{ host }}:
      type: micado.{{ host }}
  {%- endfor %}

  policies:
  - monitoring:
      type: tosca.policies.Monitoring.MiCADO
      properties:
        enable_container_metrics: false
        enable_node_metrics: false


