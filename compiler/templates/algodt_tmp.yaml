tosca_definitions_version: tosca_simple_yaml_1_2

metadata:
  id: "{{ id }}"
  name: "{{ name }}"
  author: "{{ author }}"
  date: "{{ date }}"
  version: "{{ version }}"
  classificationSchema: "{{ classificationSchema }}"
  type:
  {%- for _type in type %}
  - "{{ _type }}"
  {%- endfor %}

description: "{{ description }}"

imports:
  - https://raw.githubusercontent.com/micado-scale/tosca/digitbrain/micado_types.yaml
  {%- for microservices in algorithm["abstractHostDefinition"] %}
    {%- for microservice in microservices.items() -%}
        {%- set microservice, host = microservice %}
  - "ms-{{ microservice }}.yml"
  {%- endfor %}
  {%- endfor %}
  {%- for microservices in algorithm["abstractHostDefinition"] %}
    {%- for microservice in microservices.items() -%}
        {%- set microservice, host = microservice %}
  - "inf-{{ host }}.yml"
  {%- endfor %}
  {%- endfor %}

repositories:
  docker_hub: https://hub.docker.com/
  dbs_registry: https://dbs-container-repo.emgora.eu/v2/

topology_template:
  node_templates:
{%- for microservices in algorithm["listOfMicroservices"] %}
     {%- for microservice in microservices.items() %}
     microservice.{{microservice}}:
        type: "dbs.microservice.{{ microservice }}.{{ id }}"
        requirements:
          {%- for hosts in algorithm[ "abstractHostDefinition" ] %}
            {%- for host in hosts %}
            {%- for value in hosts.values() %}
            {%- if host == microservice %}
            - deployment.{{microservice}}
            {%- endif %}
            {%- endfor %}
    {%- endfor %}
    {%- endfor %}
    {%- endfor %}
    {%- endfor %}


  {%- for hosts in algorithm["abstractHostDefinition"] %}
  {{ hosts }}
  {%- endfor %}